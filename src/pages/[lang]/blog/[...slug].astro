---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import type { CollectionEntry } from 'astro:content';
import { locales, type Locale } from '../../../i18n/config';
import { getTranslations } from '../../../i18n/utils';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  
  return blogEntries
    .filter(entry => entry.data.lang !== 'en') // ÊéíÈô§Ëã±ÊñáÁâàÊú¨ÔºåËã±ÊñáÁâàÊú¨Âú® /blog/[...slug].astro Â§ÑÁêÜ
    .map(entry => ({
      params: { 
        lang: entry.data.lang,
        slug: entry.slug 
      },
      props: { entry },
    }));
}

interface Props {
  entry: CollectionEntry<'blog'>;
}

const { entry } = Astro.props;
const { lang } = Astro.params;
const locale = lang as Locale;
const { t } = getTranslations(locale);
const { Content } = await entry.render();

// Bengali digit conversion helper
function toBengaliNum(num: number): string {
  const bengaliDigits = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
  return num.toString().replace(/\d/g, d => bengaliDigits[parseInt(d)]);
}

// Bengali month names
const bengaliMonths = ['‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö', '‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤', '‡¶Æ‡ßá', '‡¶ú‡ßÅ‡¶®', '‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á', '‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü', '‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞', '‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'];

// Bengali date formatter
function formatBengaliDate(date: Date): string {
  const month = bengaliMonths[date.getMonth()];
  const day = toBengaliNum(date.getDate());
  const year = toBengaliNum(date.getFullYear());
  return `${month} ${day}, ${year}`;
}

// Ëé∑ÂèñÁõ∏ÂÖ≥ÊñáÁ´†
const allPosts = await getCollection('blog');
const relatedPosts = entry.data.relatedPosts
  ? allPosts.filter(post => entry.data.relatedPosts?.includes(post.slug))
  : allPosts
      .filter(post => post.slug !== entry.slug && post.data.category === entry.data.category && post.data.lang === locale)
      .slice(0, 3);

// ËÆ°ÁÆóÈòÖËØªÊó∂Èó¥ÔºàÂ¶ÇÊûúÊ≤°ÊúâÊâãÂä®ËÆæÁΩÆÔºâ
const readingTime = entry.data.readingTime || Math.ceil(entry.body.split(' ').length / 200);
---

<Layout 
  title={entry.data.title}
  description={entry.data.description}
  locale={locale}
>
  <!-- SEO Meta Tags -->
  <meta name="keywords" content={entry.data.keywords.join(', ')} />
  <meta name="author" content={entry.data.author} />
  <meta name="robots" content="index, follow" />
  {entry.data.canonicalURL && <link rel="canonical" href={entry.data.canonicalURL} />}
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content={entry.data.title} />
  <meta property="og:description" content={entry.data.description} />
  <meta property="og:type" content="article" />
  <meta property="og:url" content={`https://cutesymbols.com/${locale}/blog/${entry.slug}`} />
  <meta property="og:site_name" content="Cute Symbols" />
  <meta property="og:locale" content={locale === 'en' ? 'en_US' : locale} />
  {entry.data.heroImage && <meta property="og:image" content={entry.data.heroImage} />}
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={entry.data.title} />
  <meta name="twitter:description" content={entry.data.description} />
  {entry.data.heroImage && <meta name="twitter:image" content={entry.data.heroImage} />}
  
  <!-- Article Meta Tags -->
  <meta property="article:published_time" content={entry.data.pubDate.toISOString()} />
  {entry.data.updatedDate && <meta property="article:modified_time" content={entry.data.updatedDate.toISOString()} />}
  <meta property="article:author" content={entry.data.author} />
  <meta property="article:section" content={entry.data.category} />
  {entry.data.tags.map(tag => <meta property="article:tag" content={tag} />)}

  <!-- Schema.org ÁªìÊûÑÂåñÊï∞ÊçÆ -->
  <script type="application/ld+json" set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'Article',
    headline: entry.data.title,
    description: entry.data.description,
    image: entry.data.heroImage || 'https://cutesymbols.com/og-image.png',
    author: {
      '@type': 'Person',
      name: entry.data.author,
      url: 'https://cutesymbols.com/about'
    },
    datePublished: entry.data.pubDate.toISOString(),
    dateModified: (entry.data.updatedDate || entry.data.pubDate).toISOString(),
    keywords: entry.data.keywords.join(', '),
    articleSection: entry.data.category,
    inLanguage: locale,
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': `https://cutesymbols.com/${locale}/blog/${entry.slug}`
    },
    publisher: {
      '@type': 'Organization',
      name: 'Cute Symbols',
      logo: {
        '@type': 'ImageObject',
        url: 'https://cutesymbols.com/logo.png',
        width: 200,
        height: 60
      },
      url: 'https://cutesymbols.com'
    },
    breadcrumb: {
      '@type': 'BreadcrumbList',
      itemListElement: [
        {
          '@type': 'ListItem',
          position: 1,
          name: t('ui.home'),
          item: 'https://cutesymbols.com'
        },
        {
          '@type': 'ListItem',
          position: 2,
          name: t('ui.blog'),
          item: `https://cutesymbols.com/${locale}/blog`
        },
        {
          '@type': 'ListItem',
          position: 3,
          name: entry.data.title,
          item: `https://cutesymbols.com/${locale}/blog/${entry.slug}`
        }
      ]
    }
  })} />

  <article style={{
    maxWidth: '800px',
    margin: '0 auto',
    padding: '3rem 1rem'
  }}>
    <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
    <nav style={{
      fontSize: '0.875rem',
      color: 'var(--text-secondary)',
      marginBottom: '2rem'
    }}>
      <a href={`/${locale}/`} style={{ color: 'var(--text-secondary)', textDecoration: 'none' }}>{t('ui.home')}</a>
      {' > '}
      <a href={`/${locale}/blog`} style={{ color: 'var(--text-secondary)', textDecoration: 'none' }}>{t('ui.blog')}</a>
      {' > '}
      <span style={{ color: 'var(--text-primary)' }}>{entry.data.category}</span>
    </nav>

    <!-- ÊñáÁ´†Â§¥ÈÉ® -->
    <header style={{ marginBottom: '3rem' }}>
      <!-- ÂàÜÁ±ªÊ†áÁ≠æ -->
      <span style={{
        display: 'inline-block',
        padding: '0.375rem 1rem',
        background: 'var(--accent-color)',
        color: '#ffffff',
        borderRadius: '6px',
        fontSize: '0.875rem',
        fontWeight: 600,
        textTransform: 'uppercase',
        marginBottom: '1rem'
      }}>
        {entry.data.category}
      </span>

      <!-- Ê†áÈ¢ò -->
      <h1 style={{
        fontSize: 'clamp(1.75rem, 5vw, 2.5rem)',
        fontWeight: 700,
        lineHeight: 1.2,
        marginBottom: '1rem',
        color: 'var(--text-primary)'
      }}>
        {entry.data.title}
      </h1>

      <!-- ÊèèËø∞ -->
      <p style={{
        fontSize: '1.125rem',
        color: 'var(--text-secondary)',
        lineHeight: 1.6,
        marginBottom: '1.5rem'
      }}>
        {entry.data.description}
      </p>

      <!-- ÂÖÉ‰ø°ÊÅØ -->
      <div style={{
        display: 'flex',
        flexWrap: 'wrap',
        gap: '1.5rem',
        fontSize: '0.9375rem',
        color: 'var(--text-secondary)',
        paddingBottom: '1.5rem',
        borderBottom: '1px solid var(--border-color)'
      }}>
        <span>‚úçÔ∏è {entry.data.author}</span>
        <span>üìÖ {locale === 'bn' ? formatBengaliDate(entry.data.pubDate) : entry.data.pubDate.toLocaleDateString(locale === 'fil' ? 'en-PH' : locale === 'ms' ? 'ms-MY' : locale === 'pl' ? 'pl-PL' : 'en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
        <span>‚è±Ô∏è {locale === 'bn' ? toBengaliNum(readingTime) : readingTime} {t('blog.minRead')}</span>
        <span>üìä {t('blog.' + entry.data.difficulty) || entry.data.difficulty}</span>
      </div>
    </header>

    <!-- ÊñáÁ´†ÂÜÖÂÆπ -->
    <div class="prose" style={{
      fontSize: '1.0625rem',
      lineHeight: 1.8,
      color: 'var(--text-primary)'
    }}>
      <Content />
    </div>

    <!-- Ê†áÁ≠æ -->
    {entry.data.tags && entry.data.tags.length > 0 && (
      <div style={{
        marginTop: '3rem',
        paddingTop: '2rem',
        borderTop: '1px solid var(--border-color)'
      }}>
        <h3 style={{
          fontSize: '1rem',
          fontWeight: 600,
          marginBottom: '1rem',
          color: 'var(--text-primary)'
        }}>
          {t('ui.tags') || 'Tags'}:
        </h3>
        <div style={{
          display: 'flex',
          flexWrap: 'wrap',
          gap: '0.5rem'
        }}>
          {entry.data.tags.map(tag => (
            <span style={{
              padding: '0.375rem 0.875rem',
              background: 'var(--bg-color)',
              border: '1px solid var(--border-color)',
              borderRadius: '6px',
              fontSize: '0.875rem',
              color: 'var(--text-secondary)'
            }}>
              #{tag}
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- Áõ∏ÂÖ≥ÊñáÁ´† -->
    {relatedPosts.length > 0 && (
      <section style={{
        marginTop: '4rem',
        paddingTop: '2rem',
        borderTop: '2px solid var(--border-color)'
      }}>
        <h2 style={{
          fontSize: '1.5rem',
          fontWeight: 700,
          marginBottom: '1.5rem',
          color: 'var(--text-primary)'
        }}>
          üìö {t('ui.relatedGuides') || 'Related Guides'}
        </h2>

        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
          gap: '1.25rem'
        }}>
          {relatedPosts.map(post => (
            <a
              href={`/${locale}/blog/${post.slug}`}
              style={{
                display: 'block',
                background: 'var(--card-bg)',
                borderRadius: 'var(--radius-lg)',
                padding: '1.25rem',
                border: '1px solid var(--border-color)',
                textDecoration: 'none',
                transition: 'all 0.3s ease'
              }}
              class="related-post"
            >
              <h3 style={{
                fontSize: '1rem',
                fontWeight: 600,
                marginBottom: '0.5rem',
                color: 'var(--text-primary)',
                lineHeight: 1.4
              }}>
                {post.data.title}
              </h3>

              <p style={{
                fontSize: '0.875rem',
                color: 'var(--text-secondary)',
                lineHeight: 1.5
              }}>
                {post.data.description.slice(0, 100)}...
              </p>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- CTA -->
    <div style={{
      marginTop: '4rem',
      padding: '2rem',
      background: 'linear-gradient(135deg, #ff6b9d15 0%, #c06c8415 100%)',
      borderRadius: 'var(--radius-lg)',
      border: '2px solid var(--accent-color)',
      textAlign: 'center'
    }}>
      <h3 style={{
        fontSize: '1.5rem',
        fontWeight: 700,
        marginBottom: '1rem',
        color: 'var(--text-primary)'
      }}>
        üíñ {t('ui.loveThisGuide') || 'Love this guide?'}
      </h3>
      <p style={{
        fontSize: '1.0625rem',
        color: 'var(--text-secondary)',
        marginBottom: '1.5rem'
      }}>
        {t('ui.getMoreSymbols')}
      </p>
      <a
        href={`/${locale}/`}
        style={{
          display: 'inline-block',
          padding: '0.875rem 2rem',
          background: 'var(--accent-color)',
          color: '#ffffff',
          borderRadius: 'var(--radius-md)',
          textDecoration: 'none',
          fontWeight: 600,
          fontSize: '1rem',
          transition: 'all 0.3s ease'
        }}
        class="cta-button"
      >
        {t('ui.browseAllSymbols') || 'Browse All Symbols'} ‚Üí
      </a>
    </div>
  </article>

  <style>
    /* ProseÊ†∑Âºè - ÊñáÁ´†ÂÜÖÂÆπÊ†ºÂºèÂåñ */
    .prose h2 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-top: 2.5rem;
      margin-bottom: 1rem;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .prose h3 {
      font-size: 1.375rem;
      font-weight: 600;
      margin-top: 2rem;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
    }

    .prose h4 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .prose p {
      margin-bottom: 1.25rem;
    }

    .prose ul, .prose ol {
      margin-bottom: 1.25rem;
      padding-left: 1.5rem;
    }

    .prose li {
      margin-bottom: 0.5rem;
    }

    .prose code {
      background: var(--bg-color);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-size: 0.9375rem;
      font-family: 'Courier New', monospace;
    }

    .prose pre {
      background: var(--bg-color);
      padding: 1rem;
      border-radius: var(--radius-md);
      overflow-x: auto;
      margin-bottom: 1.25rem;
      border: 1px solid var(--border-color);
    }

    .prose pre code {
      background: none;
      padding: 0;
    }

    .prose a {
      color: var(--accent-color);
      text-decoration: underline;
    }

    .prose a:hover {
      text-decoration: none;
    }

    .prose blockquote {
      border-left: 4px solid var(--accent-color);
      padding-left: 1rem;
      margin: 1.5rem 0;
      color: var(--text-secondary);
      font-style: italic;
    }

    .prose hr {
      border: none;
      border-top: 1px solid var(--border-color);
      margin: 2rem 0;
    }

    .related-post:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--accent-color);
    }

    .cta-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    @media (max-width: 768px) {
      .prose {
        font-size: 1rem !important;
      }

      .prose h2 {
        font-size: 1.5rem !important;
      }

      .prose h3 {
        font-size: 1.25rem !important;
      }
    }
  </style>
</Layout>